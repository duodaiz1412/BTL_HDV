<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Socket.IO Test</title>
    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        #status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .connecting {
            background-color: #fff3cd;
            color: #856404;
        }
        #messages {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
        }
        button {
            padding: 8px 16px;
            margin-right: 10px;
            cursor: pointer;
        }
        input {
            padding: 8px;
            width: 200px;
        }
        .connection-options {
            margin: 15px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .option-group {
            margin-bottom: 10px;
        }
        .option-group label {
            display: inline-block;
            width: 150px;
        }
    </style>
</head>
<body>
    <h1>Socket.IO Test Client</h1>
    
    <div id="status" class="disconnected">Disconnected</div>
    
    <div class="connection-options">
        <h3>Connection Options</h3>
        <div class="option-group">
            <label for="socketUrl">Socket URL:</label>
            <input type="text" id="socketUrl" value="http://localhost:8007">
        </div>
        <div class="option-group">
            <label for="apiUrl">API URL:</label>
            <input type="text" id="apiUrl" value="http://localhost:8000">
        </div>
        <div class="option-group">
            <label for="transportMode">Transport Mode:</label>
            <select id="transportMode">
                <option value="websocket">WebSocket only</option>
                <option value="polling">Polling only</option>
                <option value="both" selected>Try both (recommended)</option>
            </select>
        </div>
        <div class="option-group">
            <label for="timeout">Timeout (ms):</label>
            <input type="number" id="timeout" value="20000">
        </div>
    </div>
    
    <div>
        <button id="connect">Connect</button>
        <button id="disconnect" disabled>Disconnect</button>
    </div>
    
    <h3>Customer ID</h3>
    <div>
        <input type="text" id="customerId" placeholder="Enter customer ID">
        <button id="joinRoom" disabled>Join Room</button>
    </div>
    
    <h3>Send Test Notification</h3>
    <div>
        <input type="text" id="notificationContent" placeholder="Notification content">
        <button id="sendNotification">Send</button>
    </div>
    
    <h3>Events</h3>
    <div id="messages"></div>
    
    <script>
        // DOM Elements
        const statusEl = document.getElementById('status');
        const messagesEl = document.getElementById('messages');
        const connectBtn = document.getElementById('connect');
        const disconnectBtn = document.getElementById('disconnect');
        const joinRoomBtn = document.getElementById('joinRoom');
        const customerIdInput = document.getElementById('customerId');
        const sendNotificationBtn = document.getElementById('sendNotification');
        const notificationContentInput = document.getElementById('notificationContent');
        const socketUrlInput = document.getElementById('socketUrl');
        const apiUrlInput = document.getElementById('apiUrl');
        const transportModeSelect = document.getElementById('transportMode');
        const timeoutInput = document.getElementById('timeout');
        
        // Socket variable
        let socket = null;
        
        function updateStatus(message, className) {
            statusEl.textContent = message;
            statusEl.className = className;
        }
        
        function addMessage(message) {
            const msgEl = document.createElement('div');
            msgEl.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            messagesEl.appendChild(msgEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }
        
        function updateButtonStates(isConnected) {
            connectBtn.disabled = isConnected;
            disconnectBtn.disabled = !isConnected;
            joinRoomBtn.disabled = !isConnected;
        }
        
        function getTransports() {
            const mode = transportModeSelect.value;
            if (mode === 'websocket') return ['websocket'];
            if (mode === 'polling') return ['polling'];
            return ['polling', 'websocket']; // Try polling first, then upgrade
        }
        
        connectBtn.addEventListener('click', () => {
            if (socket) {
                addMessage('Already connected, disconnect first');
                return;
            }
            
            const socketUrl = socketUrlInput.value.trim();
            if (!socketUrl) {
                addMessage('Please enter a valid Socket URL');
                return;
            }
            
            updateStatus('Connecting...', 'connecting');
            
            try {
                // Connect to Socket.IO server with improved options
                const timeout = parseInt(timeoutInput.value) || 20000;
                
                addMessage(`Connecting to ${socketUrl} with ${transportModeSelect.value} transport...`);
                
                socket = io(socketUrl, {
                    transports: getTransports(),
                    reconnectionAttempts: 5,
                    reconnectionDelay: 1000,
                    timeout: timeout,
                    forceNew: true
                });
                
                // Setup event listeners
                socket.on('connect', () => {
                    updateStatus('Connected', 'connected');
                    addMessage(`Connected with ID: ${socket.id}`);
                    updateButtonStates(true);
                });
                
                socket.on('notification', (data) => {
                    addMessage(`Received notification: ${JSON.stringify(data)}`);
                });
                
                socket.on('connect_error', (err) => {
                    addMessage(`Connection error: ${err.message}`);
                    updateStatus(`Error: ${err.message}`, 'disconnected');
                });
                
                socket.on('disconnect', (reason) => {
                    addMessage(`Disconnected: ${reason}`);
                    updateStatus('Disconnected', 'disconnected');
                    updateButtonStates(false);
                    socket = null;
                });
                
                // Additional debugging events
                socket.on('reconnect_attempt', (attemptNumber) => {
                    addMessage(`Reconnection attempt #${attemptNumber}`);
                });
                
                socket.on('reconnect_failed', () => {
                    addMessage('Failed to reconnect');
                });
                
                socket.io.on('upgrade', (transport) => {
                    addMessage(`Transport upgraded to: ${transport.name}`);
                });
                
                socket.io.on('error', (err) => {
                    addMessage(`Engine error: ${err}`);
                });
            } catch (err) {
                addMessage(`Error initializing socket: ${err.message}`);
                updateStatus('Error', 'disconnected');
                socket = null;
            }
        });
        
        disconnectBtn.addEventListener('click', () => {
            if (!socket) {
                addMessage('Not connected');
                return;
            }
            
            addMessage('Disconnecting...');
            socket.disconnect();
            socket = null;
            updateButtonStates(false);
        });
        
        joinRoomBtn.addEventListener('click', () => {
            if (!socket) {
                addMessage('Not connected. Please connect first.');
                return;
            }
            
            const customerId = customerIdInput.value.trim();
            if (!customerId) {
                addMessage('Please enter a customer ID');
                return;
            }
            
            socket.emit('join_room', { customer_id: customerId });
            addMessage(`Joining room for customer: ${customerId}`);
        });
        
        sendNotificationBtn.addEventListener('click', () => {
            const customerId = customerIdInput.value.trim();
            if (!customerId) {
                addMessage('Please enter a customer ID');
                return;
            }
            
            const content = notificationContentInput.value.trim();
            if (!content) {
                addMessage('Please enter notification content');
                return;
            }
            
            // Note socket connection status but still send HTTP request
            if (socket && socket.connected) {
                addMessage(`Socket connected: ${socket.id}`);
            } else {
                addMessage('Note: Not connected to WebSocket. Notification will only use HTTP API.');
            }
            
            const apiUrl = apiUrlInput.value.trim();
            
            // Using fetch to call the API Gateway endpoint
            fetch(`${apiUrl}/notifications`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    type: 'test',
                    customer_id: customerId,
                    content: content
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`API responded with status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                addMessage(`Notification sent: ${JSON.stringify(data)}`);
            })
            .catch(error => {
                addMessage(`Error sending notification: ${error.message}`);
            });
        });
    </script>
</body>
</html>